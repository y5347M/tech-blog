[{"data":1,"prerenderedAt":39},["ShallowReactive",2],{"useQiitaArticleDetailFetcher-caa5eeeba93e152cc99a":3,"useQiitaAuthorizedUser":36},{"rendered_body":4,"body":5,"coediting":6,"comments_count":7,"created_at":8,"group":9,"id":10,"likes_count":11,"private":6,"reactions_count":7,"stocks_count":7,"tags":12,"title":22,"updated_at":23,"url":24,"user":25,"page_views_count":35,"team_membership":9,"organization_url_name":9,"slide":6},"\u003Ch1 data-sourcepos=\"1:1-1:8\">\n\u003Cspan id=\"前提\" class=\"fragment\">\u003C/span>\u003Ca href=\"#%E5%89%8D%E6%8F%90\">\u003Ci class=\"fa fa-link\">\u003C/i>\u003C/a>前提\u003C/h1>\n\u003Cp data-sourcepos=\"2:1-4:89\">mysqlのテーブル定義を変えたいけど影響が大きくすぐには難しいという課題がありました。\u003Cbr>\nそのため別テーブルを作成しておいてデータは自動で同期しておきたい、というときにトリガーを使用する方法を見つけたので検証します。\u003Cbr>\nAWSのRDSを使用しているので、mysqlのバージョンは5.7を使用します。\u003C/p>\n\u003Ch1 data-sourcepos=\"6:1-6:8\">\n\u003Cspan id=\"環境\" class=\"fragment\">\u003C/span>\u003Ca href=\"#%E7%92%B0%E5%A2%83\">\u003Ci class=\"fa fa-link\">\u003C/i>\u003C/a>環境\u003C/h1>\n\u003Cul data-sourcepos=\"7:1-9:0\">\n\u003Cli data-sourcepos=\"7:1-7:13\">macOS: 12.6\u003C/li>\n\u003Cli data-sourcepos=\"8:1-9:0\">mysql: 5.7\u003C/li>\n\u003C/ul>\n\u003Ch1 data-sourcepos=\"10:1-10:8\">\n\u003Cspan id=\"準備\" class=\"fragment\">\u003C/span>\u003Ca href=\"#%E6%BA%96%E5%82%99\">\u003Ci class=\"fa fa-link\">\u003C/i>\u003C/a>準備\u003C/h1>\n\u003Ch2 data-sourcepos=\"12:1-12:38\">\n\u003Cspan id=\"docker-composeymlでmysqlを準備\" class=\"fragment\">\u003C/span>\u003Ca href=\"#docker-composeyml%E3%81%A7mysql%E3%82%92%E6%BA%96%E5%82%99\">\u003Ci class=\"fa fa-link\">\u003C/i>\u003C/a>docker-compose.ymlでmysqlを準備\u003C/h2>\n\u003Cp data-sourcepos=\"14:1-14:77\">以下のようにdocker-compose.ymlを作成してmysqlを用意します。\u003C/p>\n\u003Cdiv class=\"code-frame\" data-lang=\"yml\" data-sourcepos=\"15:1-29:3\">\n\u003Cdiv class=\"code-lang\">\u003Cspan class=\"bold\">docker-compose.yml\u003C/span>\u003C/div>\n\u003Cdiv class=\"highlight\">\u003Cpre>\u003Ccode>\u003Cspan class=\"na\">version\u003C/span>\u003Cspan class=\"pi\">:\u003C/span> \u003Cspan class=\"s1\">'\u003C/span>\u003Cspan class=\"s\">3.8'\u003C/span>\n\n\u003Cspan class=\"na\">services\u003C/span>\u003Cspan class=\"pi\">:\u003C/span>\n  \u003Cspan class=\"na\">db\u003C/span>\u003Cspan class=\"pi\">:\u003C/span>\n    \u003Cspan class=\"na\">image\u003C/span>\u003Cspan class=\"pi\">:\u003C/span> \u003Cspan class=\"s\">mysql:5.7\u003C/span>\n    \u003Cspan class=\"na\">container_name\u003C/span>\u003Cspan class=\"pi\">:\u003C/span> \u003Cspan class=\"s\">mysql\u003C/span>\n    \u003Cspan class=\"na\">environment\u003C/span>\u003Cspan class=\"pi\">:\u003C/span>\n      \u003Cspan class=\"na\">MYSQL_ROOT_PASSWORD\u003C/span>\u003Cspan class=\"pi\">:\u003C/span> \u003Cspan class=\"s\">password\u003C/span>\n      \u003Cspan class=\"na\">MYSQL_DATABASE\u003C/span>\u003Cspan class=\"pi\">:\u003C/span> \u003Cspan class=\"s\">sample_db\u003C/span>\n      \u003Cspan class=\"na\">MYSQL_USER\u003C/span>\u003Cspan class=\"pi\">:\u003C/span> \u003Cspan class=\"s\">user\u003C/span>\n      \u003Cspan class=\"na\">MYSQL_PASSWORD\u003C/span>\u003Cspan class=\"pi\">:\u003C/span> \u003Cspan class=\"s\">password\u003C/span>\n    \u003Cspan class=\"na\">ports\u003C/span>\u003Cspan class=\"pi\">:\u003C/span>\n      \u003Cspan class=\"pi\">-\u003C/span> \u003Cspan class=\"s\">3306:3306\u003C/span>\n\u003C/code>\u003C/pre>\u003C/div>\n\u003C/div>\n\u003Ch2 data-sourcepos=\"31:1-31:30\">\n\u003Cspan id=\"データベースに接続\" class=\"fragment\">\u003C/span>\u003Ca href=\"#%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%AB%E6%8E%A5%E7%B6%9A\">\u003Ci class=\"fa fa-link\">\u003C/i>\u003C/a>データベースに接続\u003C/h2>\n\u003Cp data-sourcepos=\"32:1-32:85\">私はdbeaverというツールを用いてデータベースに接続しました。\u003C/p>\n\u003Cp data-sourcepos=\"35:1-35:19\">\u003Ciframe id=\"qiita-embed-content__99415adfc6386f85b8a37088a29e255b\" src=\"https://qiita.com/embed-contents/link-card#qiita-embed-content__99415adfc6386f85b8a37088a29e255b\" data-content=\"https%3A%2F%2Fdbeaver.io%2F\" frameborder=\"0\" scrolling=\"no\" loading=\"lazy\" style=\"width:100%;\" height=\"29\">\n\u003C/iframe>\n\u003C/p>\n\u003Cp data-sourcepos=\"37:1-38:139\">こちらの情報で接続することができます。\u003Cbr>\n\u003Ca href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F2433961%2Fa67ba970-88aa-924e-aabb-07107df3fd9d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=609b5a3c7b5d0fb1fd1176797942adfd\" target=\"_blank\" rel=\"nofollow noopener\">\u003Cimg width=\"600\" alt=\"\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F2433961%2Fa67ba970-88aa-924e-aabb-07107df3fd9d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=609b5a3c7b5d0fb1fd1176797942adfd\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F2433961%2Fa67ba970-88aa-924e-aabb-07107df3fd9d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=c454081564789bcfb6b7dd8d86e65fc4 1x\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2433961/a67ba970-88aa-924e-aabb-07107df3fd9d.png\" loading=\"lazy\">\u003C/a>\u003C/p>\n\u003Ch2 data-sourcepos=\"40:1-40:24\">\n\u003Cspan id=\"テーブルを作成\" class=\"fragment\">\u003C/span>\u003Ca href=\"#%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90\">\u003Ci class=\"fa fa-link\">\u003C/i>\u003C/a>テーブルを作成\u003C/h2>\n\u003Cp data-sourcepos=\"41:1-42:200\">データコピー元のテーブル\u003Ccode>origin_table\u003C/code>とコピー先のテーブル\u003Ccode>copied_table\u003C/code>を作成します。\u003Cbr>\n\u003Ccode>origin_table.num_data\u003C/code>カラムに入る数字を\u003Ccode>copied_table.varchar_data\u003C/code>カラムへコピーしますが、そのとき数字を文字列に変換するようにトリガーで設定します。\u003C/p>\n\u003Cp data-sourcepos=\"44:1-44:62\">（IDのみ大文字になってしまってました…。）\u003C/p>\n\u003Cdiv class=\"code-frame\" data-lang=\"sql\" data-sourcepos=\"46:1-59:3\">\n\u003Cdiv class=\"code-lang\">\u003Cspan class=\"bold\">origin_table\u003C/span>\u003C/div>\n\u003Cdiv class=\"highlight\">\u003Cpre>\u003Ccode>\u003Cspan class=\"k\">CREATE\u003C/span> \u003Cspan class=\"k\">TABLE\u003C/span> \u003Cspan class=\"n\">sample_db\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"n\">origin_table\u003C/span> \u003Cspan class=\"p\">(\u003C/span>\n\t\u003Cspan class=\"n\">ID\u003C/span> \u003Cspan class=\"nb\">BIGINT\u003C/span> \u003Cspan class=\"n\">auto_increment\u003C/span> \u003Cspan class=\"k\">NOT\u003C/span> \u003Cspan class=\"k\">NULL\u003C/span> \u003Cspan class=\"k\">COMMENT\u003C/span> \u003Cspan class=\"s1\">'ID'\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\u003Cspan class=\"n\">num_data\u003C/span> \u003Cspan class=\"nb\">INTEGER\u003C/span> \u003Cspan class=\"k\">DEFAULT\u003C/span> \u003Cspan class=\"mi\">0\u003C/span> \u003Cspan class=\"k\">NOT\u003C/span> \u003Cspan class=\"k\">NULL\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\u003Cspan class=\"n\">create_user\u003C/span> \u003Cspan class=\"nb\">varchar\u003C/span>\u003Cspan class=\"p\">(\u003C/span>\u003Cspan class=\"mi\">100\u003C/span>\u003Cspan class=\"p\">)\u003C/span> \u003Cspan class=\"k\">NOT\u003C/span> \u003Cspan class=\"k\">NULL\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\u003Cspan class=\"n\">create_datetime\u003C/span> \u003Cspan class=\"nb\">DATETIME\u003C/span> \u003Cspan class=\"k\">NOT\u003C/span> \u003Cspan class=\"k\">NULL\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\u003Cspan class=\"n\">update_user\u003C/span> \u003Cspan class=\"nb\">varchar\u003C/span>\u003Cspan class=\"p\">(\u003C/span>\u003Cspan class=\"mi\">100\u003C/span>\u003Cspan class=\"p\">)\u003C/span> \u003Cspan class=\"k\">NOT\u003C/span> \u003Cspan class=\"k\">NULL\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\u003Cspan class=\"n\">update_datetime\u003C/span> \u003Cspan class=\"nb\">DATETIME\u003C/span> \u003Cspan class=\"k\">NOT\u003C/span> \u003Cspan class=\"k\">NULL\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\u003Cspan class=\"k\">CONSTRAINT\u003C/span> \u003Cspan class=\"n\">origin_table_PK\u003C/span> \u003Cspan class=\"k\">PRIMARY\u003C/span> \u003Cspan class=\"k\">KEY\u003C/span> \u003Cspan class=\"p\">(\u003C/span>\u003Cspan class=\"n\">ID\u003C/span>\u003Cspan class=\"p\">)\u003C/span>\n\u003Cspan class=\"p\">)\u003C/span>\n\u003Cspan class=\"n\">ENGINE\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"n\">InnoDB\u003C/span>\n\u003Cspan class=\"k\">DEFAULT\u003C/span> \u003Cspan class=\"n\">CHARSET\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"n\">utf8mb4\u003C/span>\n\u003Cspan class=\"k\">COLLATE\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"n\">utf8mb4_general_ci\u003C/span>\u003Cspan class=\"p\">;\u003C/span>\n\u003C/code>\u003C/pre>\u003C/div>\n\u003C/div>\n\u003Cdiv class=\"code-frame\" data-lang=\"sql\" data-sourcepos=\"61:1-74:3\">\n\u003Cdiv class=\"code-lang\">\u003Cspan class=\"bold\">copied_table\u003C/span>\u003C/div>\n\u003Cdiv class=\"highlight\">\u003Cpre>\u003Ccode>\u003Cspan class=\"k\">CREATE\u003C/span> \u003Cspan class=\"k\">TABLE\u003C/span> \u003Cspan class=\"n\">sample_db\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"n\">copied_table\u003C/span> \u003Cspan class=\"p\">(\u003C/span>\n\t\u003Cspan class=\"n\">ID\u003C/span> \u003Cspan class=\"nb\">bigint\u003C/span>\u003Cspan class=\"p\">(\u003C/span>\u003Cspan class=\"mi\">20\u003C/span>\u003Cspan class=\"p\">)\u003C/span> \u003Cspan class=\"n\">auto_increment\u003C/span> \u003Cspan class=\"k\">NOT\u003C/span> \u003Cspan class=\"k\">NULL\u003C/span> \u003Cspan class=\"k\">COMMENT\u003C/span> \u003Cspan class=\"s1\">'ID'\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\u003Cspan class=\"n\">varchar_data\u003C/span> \u003Cspan class=\"nb\">varchar\u003C/span>\u003Cspan class=\"p\">(\u003C/span>\u003Cspan class=\"mi\">100\u003C/span>\u003Cspan class=\"p\">)\u003C/span> \u003Cspan class=\"k\">NOT\u003C/span> \u003Cspan class=\"k\">NULL\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\u003Cspan class=\"n\">create_user\u003C/span> \u003Cspan class=\"nb\">varchar\u003C/span>\u003Cspan class=\"p\">(\u003C/span>\u003Cspan class=\"mi\">100\u003C/span>\u003Cspan class=\"p\">)\u003C/span> \u003Cspan class=\"nb\">CHARACTER\u003C/span> \u003Cspan class=\"k\">SET\u003C/span> \u003Cspan class=\"n\">utf8mb4\u003C/span> \u003Cspan class=\"k\">COLLATE\u003C/span> \u003Cspan class=\"n\">utf8mb4_general_ci\u003C/span> \u003Cspan class=\"k\">NOT\u003C/span> \u003Cspan class=\"k\">NULL\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\u003Cspan class=\"n\">create_datetime\u003C/span> \u003Cspan class=\"nb\">datetime\u003C/span> \u003Cspan class=\"k\">NOT\u003C/span> \u003Cspan class=\"k\">NULL\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\u003Cspan class=\"n\">update_user\u003C/span> \u003Cspan class=\"nb\">varchar\u003C/span>\u003Cspan class=\"p\">(\u003C/span>\u003Cspan class=\"mi\">100\u003C/span>\u003Cspan class=\"p\">)\u003C/span> \u003Cspan class=\"nb\">CHARACTER\u003C/span> \u003Cspan class=\"k\">SET\u003C/span> \u003Cspan class=\"n\">utf8mb4\u003C/span> \u003Cspan class=\"k\">COLLATE\u003C/span> \u003Cspan class=\"n\">utf8mb4_general_ci\u003C/span> \u003Cspan class=\"k\">NOT\u003C/span> \u003Cspan class=\"k\">NULL\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\u003Cspan class=\"n\">update_datetime\u003C/span> \u003Cspan class=\"nb\">datetime\u003C/span> \u003Cspan class=\"k\">NOT\u003C/span> \u003Cspan class=\"k\">NULL\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\u003Cspan class=\"k\">CONSTRAINT\u003C/span> \u003Cspan class=\"nv\">`PRIMARY`\u003C/span> \u003Cspan class=\"k\">PRIMARY\u003C/span> \u003Cspan class=\"k\">KEY\u003C/span> \u003Cspan class=\"p\">(\u003C/span>\u003Cspan class=\"n\">ID\u003C/span>\u003Cspan class=\"p\">)\u003C/span>\n\u003Cspan class=\"p\">)\u003C/span>\n\u003Cspan class=\"n\">ENGINE\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"n\">InnoDB\u003C/span>\n\u003Cspan class=\"k\">DEFAULT\u003C/span> \u003Cspan class=\"n\">CHARSET\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"n\">utf8mb4\u003C/span>\n\u003Cspan class=\"k\">COLLATE\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"n\">utf8mb4_general_ci\u003C/span>\u003Cspan class=\"p\">;\u003C/span>\n\u003C/code>\u003C/pre>\u003C/div>\n\u003C/div>\n\u003Ch1 data-sourcepos=\"76:1-76:23\">\n\u003Cspan id=\"トリガーの作成\" class=\"fragment\">\u003C/span>\u003Ca href=\"#%E3%83%88%E3%83%AA%E3%82%AC%E3%83%BC%E3%81%AE%E4%BD%9C%E6%88%90\">\u003Ci class=\"fa fa-link\">\u003C/i>\u003C/a>トリガーの作成\u003C/h1>\n\u003Ch2 data-sourcepos=\"78:1-78:51\">\n\u003Cspan id=\"データ作成時に実行されるトリガー\" class=\"fragment\">\u003C/span>\u003Ca href=\"#%E3%83%87%E3%83%BC%E3%82%BF%E4%BD%9C%E6%88%90%E6%99%82%E3%81%AB%E5%AE%9F%E8%A1%8C%E3%81%95%E3%82%8C%E3%82%8B%E3%83%88%E3%83%AA%E3%82%AC%E3%83%BC\">\u003Ci class=\"fa fa-link\">\u003C/i>\u003C/a>データ作成時に実行されるトリガー\u003C/h2>\n\u003Cp data-sourcepos=\"80:1-81:156\">\u003Ccode>origin_table.num_data\u003C/code>を\u003Ccode>copied_table.varchar_data\u003C/code>にコピーする際、IF文で分岐して一度変数に格納するようにしました。これはプログラム内のenumのようなものでデータを入れる想定なので、その通り分岐するようにしています。\u003Cbr>\n\u003Ccode>NEW\u003C/code>はレコードへのSQL文を実行した後の値を指しています。\u003Ccode>NEW.ID\u003C/code>はデータ登録後にできたレコードのIDを指します。\u003C/p>\n\u003Cdiv class=\"code-frame\" data-lang=\"sql\" data-sourcepos=\"83:1-107:3\">\n\u003Cdiv class=\"code-lang\">\u003Cspan class=\"bold\">origin_table_insert_trigger\u003C/span>\u003C/div>\n\u003Cdiv class=\"highlight\">\u003Cpre>\u003Ccode>\u003Cspan class=\"k\">DROP\u003C/span> \u003Cspan class=\"k\">TRIGGER\u003C/span> \u003Cspan class=\"n\">IF\u003C/span> \u003Cspan class=\"k\">EXISTS\u003C/span> \u003Cspan class=\"n\">sample_db\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"n\">origin_table_insert_trigger\u003C/span>\u003Cspan class=\"p\">;\u003C/span>\n\u003Cspan class=\"k\">DELIMITER\u003C/span> \u003Cspan class=\"err\">$$\u003C/span>\n\u003Cspan class=\"err\">$$\u003C/span>\n\u003Cspan class=\"k\">CREATE\u003C/span> \u003Cspan class=\"k\">TRIGGER\u003C/span> \u003Cspan class=\"n\">origin_table_insert_trigger\u003C/span> \u003Cspan class=\"k\">AFTER\u003C/span> \u003Cspan class=\"k\">INSERT\u003C/span> \u003Cspan class=\"k\">ON\u003C/span> \u003Cspan class=\"n\">origin_table\u003C/span> \u003Cspan class=\"k\">FOR\u003C/span> \u003Cspan class=\"k\">EACH\u003C/span> \u003Cspan class=\"k\">ROW\u003C/span>\n\u003Cspan class=\"k\">BEGIN\u003C/span> \n\t\u003Cspan class=\"k\">DECLARE\u003C/span> \u003Cspan class=\"n\">varchar_data_tmp\u003C/span> \u003Cspan class=\"nb\">varchar\u003C/span>\u003Cspan class=\"p\">(\u003C/span>\u003Cspan class=\"mi\">100\u003C/span>\u003Cspan class=\"p\">);\u003C/span>\n\t\u003Cspan class=\"n\">IF\u003C/span> \u003Cspan class=\"k\">NEW\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"nv\">`num_data`\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"mi\">1\u003C/span> \u003Cspan class=\"k\">THEN\u003C/span>\n\t\t\u003Cspan class=\"k\">SET\u003C/span> \u003Cspan class=\"n\">varchar_data_tmp\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"s1\">'ONE'\u003C/span> \u003Cspan class=\"p\">;\u003C/span>\n\t\u003Cspan class=\"n\">ELSEIF\u003C/span> \u003Cspan class=\"k\">NEW\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"nv\">`num_data`\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"mi\">2\u003C/span> \u003Cspan class=\"k\">THEN\u003C/span>\n\t\t\u003Cspan class=\"k\">SET\u003C/span> \u003Cspan class=\"n\">varchar_data_tmp\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"s1\">'TWO'\u003C/span> \u003Cspan class=\"p\">;\u003C/span>\n\t\u003Cspan class=\"k\">ELSE\u003C/span>\n\t\t\u003Cspan class=\"k\">SET\u003C/span> \u003Cspan class=\"n\">varchar_data_tmp\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"s1\">'OTHER'\u003C/span> \u003Cspan class=\"p\">;\u003C/span>\n\t\u003Cspan class=\"k\">END\u003C/span> \u003Cspan class=\"n\">IF\u003C/span>\u003Cspan class=\"p\">;\u003C/span>\n\t\n\t\u003Cspan class=\"k\">INSERT\u003C/span> \u003Cspan class=\"k\">INTO\u003C/span> \u003Cspan class=\"n\">copied_table\u003C/span> \u003Cspan class=\"k\">SET\u003C/span>\n\t\t\u003Cspan class=\"nv\">`ID`\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"k\">NEW\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"nv\">`ID`\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\t\u003Cspan class=\"nv\">`varchar_data`\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"n\">varchar_data_tmp\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\t\u003Cspan class=\"nv\">`create_user`\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"k\">NEW\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"nv\">`create_user`\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\t\u003Cspan class=\"nv\">`create_datetime`\u003C/span> \u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"k\">NEW\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"nv\">`create_datetime`\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\t\u003Cspan class=\"nv\">`update_user`\u003C/span> \u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"k\">NEW\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"nv\">`update_user`\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\t\u003Cspan class=\"nv\">`update_datetime`\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"k\">NEW\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"nv\">`update_datetime`\u003C/span>\u003Cspan class=\"p\">;\u003C/span>\n\u003Cspan class=\"k\">END\u003C/span>\u003Cspan class=\"err\">$$\u003C/span>\n\u003Cspan class=\"k\">DELIMITER\u003C/span> \u003Cspan class=\"p\">;\u003C/span>\n\u003C/code>\u003C/pre>\u003C/div>\n\u003C/div>\n\u003Cp data-sourcepos=\"109:1-110:139\">ためしにデータを登録すると以下の通りデータがコピーされます。データの変換もできています。\u003Cbr>\n\u003Ca href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F2433961%2F3a93e9d6-a011-09ed-7f99-3bca58322b2a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=dae2022bb1e68f48b557405a5e87bfe5\" target=\"_blank\" rel=\"nofollow noopener\">\u003Cimg width=\"800\" alt=\"\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F2433961%2F3a93e9d6-a011-09ed-7f99-3bca58322b2a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=dae2022bb1e68f48b557405a5e87bfe5\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F2433961%2F3a93e9d6-a011-09ed-7f99-3bca58322b2a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=ff28e687c4697cad9b1303fca6c589d4 1x\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2433961/3a93e9d6-a011-09ed-7f99-3bca58322b2a.png\" loading=\"lazy\">\u003C/a>\u003C/p>\n\u003Ch2 data-sourcepos=\"112:1-112:51\">\n\u003Cspan id=\"データ更新時に実行されるトリガー\" class=\"fragment\">\u003C/span>\u003Ca href=\"#%E3%83%87%E3%83%BC%E3%82%BF%E6%9B%B4%E6%96%B0%E6%99%82%E3%81%AB%E5%AE%9F%E8%A1%8C%E3%81%95%E3%82%8C%E3%82%8B%E3%83%88%E3%83%AA%E3%82%AC%E3%83%BC\">\u003Ci class=\"fa fa-link\">\u003C/i>\u003C/a>データ更新時に実行されるトリガー\u003C/h2>\n\u003Cp data-sourcepos=\"113:1-113:67\">INSERT文とは異なり、WHERE句でIDを指定しています。\u003C/p>\n\u003Cdiv class=\"code-frame\" data-lang=\"sql\" data-sourcepos=\"115:1-139:3\">\n\u003Cdiv class=\"code-lang\">\u003Cspan class=\"bold\">origin_table_update_trigger\u003C/span>\u003C/div>\n\u003Cdiv class=\"highlight\">\u003Cpre>\u003Ccode>\u003Cspan class=\"k\">DROP\u003C/span> \u003Cspan class=\"k\">TRIGGER\u003C/span> \u003Cspan class=\"n\">IF\u003C/span> \u003Cspan class=\"k\">EXISTS\u003C/span> \u003Cspan class=\"n\">sample_db\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"n\">origin_table_update_trigger\u003C/span>\u003Cspan class=\"p\">;\u003C/span>\n\u003Cspan class=\"k\">DELIMITER\u003C/span> \u003Cspan class=\"err\">$$\u003C/span>\n\u003Cspan class=\"err\">$$\u003C/span>\n\u003Cspan class=\"k\">CREATE\u003C/span> \u003Cspan class=\"k\">TRIGGER\u003C/span> \u003Cspan class=\"n\">origin_table_update_trigger\u003C/span> \u003Cspan class=\"k\">AFTER\u003C/span> \u003Cspan class=\"k\">UPDATE\u003C/span> \u003Cspan class=\"k\">ON\u003C/span> \u003Cspan class=\"n\">origin_table\u003C/span> \u003Cspan class=\"k\">FOR\u003C/span> \u003Cspan class=\"k\">EACH\u003C/span> \u003Cspan class=\"k\">ROW\u003C/span>\n\u003Cspan class=\"k\">BEGIN\u003C/span> \n\t\u003Cspan class=\"k\">DECLARE\u003C/span> \u003Cspan class=\"n\">varchar_data_tmp\u003C/span> \u003Cspan class=\"nb\">varchar\u003C/span>\u003Cspan class=\"p\">(\u003C/span>\u003Cspan class=\"mi\">100\u003C/span>\u003Cspan class=\"p\">);\u003C/span>\n\t\u003Cspan class=\"n\">IF\u003C/span> \u003Cspan class=\"k\">NEW\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"nv\">`num_data`\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"mi\">1\u003C/span> \u003Cspan class=\"k\">THEN\u003C/span>\n\t\t\u003Cspan class=\"k\">SET\u003C/span> \u003Cspan class=\"n\">varchar_data_tmp\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"s1\">'ONE'\u003C/span> \u003Cspan class=\"p\">;\u003C/span>\n\t\u003Cspan class=\"n\">ELSEIF\u003C/span> \u003Cspan class=\"k\">NEW\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"nv\">`num_data`\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"mi\">2\u003C/span> \u003Cspan class=\"k\">THEN\u003C/span>\n\t\t\u003Cspan class=\"k\">SET\u003C/span> \u003Cspan class=\"n\">varchar_data_tmp\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"s1\">'TWO'\u003C/span> \u003Cspan class=\"p\">;\u003C/span>\n\t\u003Cspan class=\"k\">ELSE\u003C/span>\n\t\t\u003Cspan class=\"k\">SET\u003C/span> \u003Cspan class=\"n\">varchar_data_tmp\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"s1\">'OTHER'\u003C/span> \u003Cspan class=\"p\">;\u003C/span>\n\t\u003Cspan class=\"k\">END\u003C/span> \u003Cspan class=\"n\">IF\u003C/span>\u003Cspan class=\"p\">;\u003C/span>\n\t\n\t\u003Cspan class=\"k\">UPDATE\u003C/span> \u003Cspan class=\"n\">copied_table\u003C/span> \u003Cspan class=\"k\">SET\u003C/span>\n\t\t\u003Cspan class=\"nv\">`varchar_data`\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"n\">varchar_data_tmp\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\t\u003Cspan class=\"nv\">`create_user`\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"k\">NEW\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"nv\">`create_user`\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\t\u003Cspan class=\"nv\">`create_datetime`\u003C/span> \u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"k\">NEW\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"nv\">`create_datetime`\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\t\u003Cspan class=\"nv\">`update_user`\u003C/span> \u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"k\">NEW\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"nv\">`update_user`\u003C/span>\u003Cspan class=\"p\">,\u003C/span>\n\t\t\u003Cspan class=\"nv\">`update_datetime`\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"k\">NEW\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"nv\">`update_datetime`\u003C/span>\n\t\u003Cspan class=\"k\">WHERE\u003C/span> \u003Cspan class=\"nv\">`ID`\u003C/span> \u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"k\">NEW\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"nv\">`ID`\u003C/span>\u003Cspan class=\"p\">;\u003C/span>\n\u003Cspan class=\"k\">END\u003C/span>\u003Cspan class=\"err\">$$\u003C/span>\n\u003Cspan class=\"k\">DELIMITER\u003C/span> \u003Cspan class=\"p\">;\u003C/span>\n\u003C/code>\u003C/pre>\u003C/div>\n\u003C/div>\n\u003Cp data-sourcepos=\"141:1-142:139\">ID以外のデータを更新してみます。こちらもデータの変換がしっかりできています。\u003Cbr>\n\u003Ca href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F2433961%2F5eb30c4c-c008-8e5e-9713-8b5110f2c748.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=bb5ea77c69fc12c33b12e00a5deae366\" target=\"_blank\" rel=\"nofollow noopener\">\u003Cimg width=\"800\" alt=\"\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F2433961%2F5eb30c4c-c008-8e5e-9713-8b5110f2c748.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=bb5ea77c69fc12c33b12e00a5deae366\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F2433961%2F5eb30c4c-c008-8e5e-9713-8b5110f2c748.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=66def55ee7218840a0b76c3122107466 1x\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2433961/5eb30c4c-c008-8e5e-9713-8b5110f2c748.png\" loading=\"lazy\">\u003C/a>\u003C/p>\n\u003Ch2 data-sourcepos=\"144:1-144:51\">\n\u003Cspan id=\"データ削除時に実行されるトリガー\" class=\"fragment\">\u003C/span>\u003Ca href=\"#%E3%83%87%E3%83%BC%E3%82%BF%E5%89%8A%E9%99%A4%E6%99%82%E3%81%AB%E5%AE%9F%E8%A1%8C%E3%81%95%E3%82%8C%E3%82%8B%E3%83%88%E3%83%AA%E3%82%AC%E3%83%BC\">\u003Ci class=\"fa fa-link\">\u003C/i>\u003C/a>データ削除時に実行されるトリガー\u003C/h2>\n\u003Cp data-sourcepos=\"146:1-146:220\">注意点として、DELETE時に実行されるトリガーは\u003Ccode>NEW\u003C/code>を使用できないことです。\u003Ccode>NEW\u003C/code>はレコードに変化があった後の値なので、削除実行後は存在しなくなるためです。\u003C/p>\n\u003Cdiv class=\"code-frame\" data-lang=\"sql\" data-sourcepos=\"147:1-156:3\">\n\u003Cdiv class=\"code-lang\">\u003Cspan class=\"bold\">origin_table_delete_trigger\u003C/span>\u003C/div>\n\u003Cdiv class=\"highlight\">\u003Cpre>\u003Ccode>\u003Cspan class=\"k\">DROP\u003C/span> \u003Cspan class=\"k\">TRIGGER\u003C/span> \u003Cspan class=\"n\">IF\u003C/span> \u003Cspan class=\"k\">EXISTS\u003C/span> \u003Cspan class=\"n\">sample_db\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"n\">origin_table_delete_trigger\u003C/span>\u003Cspan class=\"p\">;\u003C/span>\n\u003Cspan class=\"k\">DELIMITER\u003C/span> \u003Cspan class=\"err\">$$\u003C/span>\n\u003Cspan class=\"err\">$$\u003C/span>\n\u003Cspan class=\"k\">CREATE\u003C/span> \u003Cspan class=\"k\">TRIGGER\u003C/span> \u003Cspan class=\"n\">origin_table_delete_trigger\u003C/span> \u003Cspan class=\"k\">AFTER\u003C/span> \u003Cspan class=\"k\">DELETE\u003C/span> \u003Cspan class=\"k\">ON\u003C/span> \u003Cspan class=\"n\">origin_table\u003C/span> \u003Cspan class=\"k\">FOR\u003C/span> \u003Cspan class=\"k\">EACH\u003C/span> \u003Cspan class=\"k\">ROW\u003C/span>\n\u003Cspan class=\"k\">BEGIN\u003C/span> \t\n\t\u003Cspan class=\"k\">DELETE\u003C/span> \u003Cspan class=\"k\">FROM\u003C/span> \u003Cspan class=\"n\">copied_table\u003C/span> \u003Cspan class=\"k\">WHERE\u003C/span> \u003Cspan class=\"nv\">`ID`\u003C/span>\u003Cspan class=\"o\">=\u003C/span>\u003Cspan class=\"k\">OLD\u003C/span>\u003Cspan class=\"p\">.\u003C/span>\u003Cspan class=\"nv\">`ID`\u003C/span>\u003Cspan class=\"p\">;\u003C/span>\n\u003Cspan class=\"k\">END\u003C/span>\u003Cspan class=\"err\">$$\u003C/span>\n\u003Cspan class=\"k\">DELIMITER\u003C/span> \u003Cspan class=\"p\">;\u003C/span>\n\u003C/code>\u003C/pre>\u003C/div>\n\u003C/div>\n\u003Cp data-sourcepos=\"158:1-159:139\">削除してみると該当のデータが消えていることがわかります。\u003Cbr>\n\u003Ca href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F2433961%2Fa0b485aa-034c-59e7-02b8-4399ec0cabb1.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=54793dc87868da51207a5d3c268eaf85\" target=\"_blank\" rel=\"nofollow noopener\">\u003Cimg width=\"800\" alt=\"\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F2433961%2Fa0b485aa-034c-59e7-02b8-4399ec0cabb1.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=54793dc87868da51207a5d3c268eaf85\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F2433961%2Fa0b485aa-034c-59e7-02b8-4399ec0cabb1.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=879c76bf1ea31606e31fd8a39bd5c355 1x\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2433961/a0b485aa-034c-59e7-02b8-4399ec0cabb1.png\" loading=\"lazy\">\u003C/a>\u003C/p>\n\u003Ch1 data-sourcepos=\"161:1-161:14\">\n\u003Cspan id=\"さいごに\" class=\"fragment\">\u003C/span>\u003Ca href=\"#%E3%81%95%E3%81%84%E3%81%94%E3%81%AB\">\u003Ci class=\"fa fa-link\">\u003C/i>\u003C/a>さいごに\u003C/h1>\n\u003Cp data-sourcepos=\"162:1-163:253\">データを変換する処理のところは少し骨が折れましたが、これでうまく動作しました。\u003Cbr>\nトリガー定義を資源管理することや、ログなどを適切に管理することができれば、SQL文実行前後で何か処理をしたい場合の有効な方法の1つとなり得ます。ぜひ使っていきたいと思います。\u003C/p>\n","# 前提\nmysqlのテーブル定義を変えたいけど影響が大きくすぐには難しいという課題がありました。\nそのため別テーブルを作成しておいてデータは自動で同期しておきたい、というときにトリガーを使用する方法を見つけたので検証します。\nAWSのRDSを使用しているので、mysqlのバージョンは5.7を使用します。\n\n# 環境\n- macOS: 12.6\n- mysql: 5.7\n\n# 準備\n\n## docker-compose.ymlでmysqlを準備\n\n以下のようにdocker-compose.ymlを作成してmysqlを用意します。\n```yml:docker-compose.yml\nversion: '3.8'\n\nservices:\n  db:\n    image: mysql:5.7\n    container_name: mysql\n    environment:\n      MYSQL_ROOT_PASSWORD: password\n      MYSQL_DATABASE: sample_db\n      MYSQL_USER: user\n      MYSQL_PASSWORD: password\n    ports:\n      - 3306:3306\n```\n\n## データベースに接続\n私はdbeaverというツールを用いてデータベースに接続しました。\n\n\nhttps://dbeaver.io/\n\nこちらの情報で接続することができます。\n\u003Cimg width=\"600\" alt=\"\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2433961/a67ba970-88aa-924e-aabb-07107df3fd9d.png\">\n\n## テーブルを作成\nデータコピー元のテーブル`origin_table`とコピー先のテーブル`copied_table`を作成します。\n`origin_table.num_data`カラムに入る数字を`copied_table.varchar_data`カラムへコピーしますが、そのとき数字を文字列に変換するようにトリガーで設定します。\n\n（IDのみ大文字になってしまってました…。）\n\n```sql:origin_table\nCREATE TABLE sample_db.origin_table (\n\tID BIGINT auto_increment NOT NULL COMMENT 'ID',\n\tnum_data INTEGER DEFAULT 0 NOT NULL,\n\tcreate_user varchar(100) NOT NULL,\n\tcreate_datetime DATETIME NOT NULL,\n\tupdate_user varchar(100) NOT NULL,\n\tupdate_datetime DATETIME NOT NULL,\n\tCONSTRAINT origin_table_PK PRIMARY KEY (ID)\n)\nENGINE=InnoDB\nDEFAULT CHARSET=utf8mb4\nCOLLATE=utf8mb4_general_ci;\n```\n\n```sql:copied_table\nCREATE TABLE sample_db.copied_table (\n\tID bigint(20) auto_increment NOT NULL COMMENT 'ID',\n\tvarchar_data varchar(100) NOT NULL,\n\tcreate_user varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL,\n\tcreate_datetime datetime NOT NULL,\n\tupdate_user varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL,\n\tupdate_datetime datetime NOT NULL,\n\tCONSTRAINT `PRIMARY` PRIMARY KEY (ID)\n)\nENGINE=InnoDB\nDEFAULT CHARSET=utf8mb4\nCOLLATE=utf8mb4_general_ci;\n```\n\n# トリガーの作成\n\n## データ作成時に実行されるトリガー\n\n`origin_table.num_data`を`copied_table.varchar_data`にコピーする際、IF文で分岐して一度変数に格納するようにしました。これはプログラム内のenumのようなものでデータを入れる想定なので、その通り分岐するようにしています。\n`NEW`はレコードへのSQL文を実行した後の値を指しています。`NEW.ID`はデータ登録後にできたレコードのIDを指します。\n\n```sql:origin_table_insert_trigger\nDROP TRIGGER IF EXISTS sample_db.origin_table_insert_trigger;\nDELIMITER $$\n$$\nCREATE TRIGGER origin_table_insert_trigger AFTER INSERT ON origin_table FOR EACH ROW\nBEGIN \n\tDECLARE varchar_data_tmp varchar(100);\n\tIF NEW.`num_data`=1 THEN\n\t\tSET varchar_data_tmp='ONE' ;\n\tELSEIF NEW.`num_data`=2 THEN\n\t\tSET varchar_data_tmp='TWO' ;\n\tELSE\n\t\tSET varchar_data_tmp='OTHER' ;\n\tEND IF;\n\t\n\tINSERT INTO copied_table SET\n\t\t`ID`=NEW.`ID`,\n\t\t`varchar_data`=varchar_data_tmp,\n\t\t`create_user`=NEW.`create_user`,\n\t\t`create_datetime` =NEW.`create_datetime`,\n\t\t`update_user` =NEW.`update_user`,\n\t\t`update_datetime`=NEW.`update_datetime`;\nEND$$\nDELIMITER ;\n```\n\nためしにデータを登録すると以下の通りデータがコピーされます。データの変換もできています。\n\u003Cimg width=\"800\" alt=\"\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2433961/3a93e9d6-a011-09ed-7f99-3bca58322b2a.png\">\n\n## データ更新時に実行されるトリガー\nINSERT文とは異なり、WHERE句でIDを指定しています。\n\n```sql:origin_table_update_trigger\nDROP TRIGGER IF EXISTS sample_db.origin_table_update_trigger;\nDELIMITER $$\n$$\nCREATE TRIGGER origin_table_update_trigger AFTER UPDATE ON origin_table FOR EACH ROW\nBEGIN \n\tDECLARE varchar_data_tmp varchar(100);\n\tIF NEW.`num_data`=1 THEN\n\t\tSET varchar_data_tmp='ONE' ;\n\tELSEIF NEW.`num_data`=2 THEN\n\t\tSET varchar_data_tmp='TWO' ;\n\tELSE\n\t\tSET varchar_data_tmp='OTHER' ;\n\tEND IF;\n\t\n\tUPDATE copied_table SET\n\t\t`varchar_data`=varchar_data_tmp,\n\t\t`create_user`=NEW.`create_user`,\n\t\t`create_datetime` =NEW.`create_datetime`,\n\t\t`update_user` =NEW.`update_user`,\n\t\t`update_datetime`=NEW.`update_datetime`\n\tWHERE `ID` =NEW.`ID`;\nEND$$\nDELIMITER ;\n```\n\nID以外のデータを更新してみます。こちらもデータの変換がしっかりできています。\n\u003Cimg width=\"800\" alt=\"\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2433961/5eb30c4c-c008-8e5e-9713-8b5110f2c748.png\">\n\n## データ削除時に実行されるトリガー\n\n注意点として、DELETE時に実行されるトリガーは`NEW`を使用できないことです。`NEW`はレコードに変化があった後の値なので、削除実行後は存在しなくなるためです。\n```sql:origin_table_delete_trigger\nDROP TRIGGER IF EXISTS sample_db.origin_table_delete_trigger;\nDELIMITER $$\n$$\nCREATE TRIGGER origin_table_delete_trigger AFTER DELETE ON origin_table FOR EACH ROW\nBEGIN \t\n\tDELETE FROM copied_table WHERE `ID`=OLD.`ID`;\nEND$$\nDELIMITER ;\n```\n\n削除してみると該当のデータが消えていることがわかります。\n\u003Cimg width=\"800\" alt=\"\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2433961/a0b485aa-034c-59e7-02b8-4399ec0cabb1.png\">\n\n# さいごに\nデータを変換する処理のところは少し骨が折れましたが、これでうまく動作しました。\nトリガー定義を資源管理することや、ログなどを適切に管理することができれば、SQL文実行前後で何か処理をしたい場合の有効な方法の1つとなり得ます。ぜひ使っていきたいと思います。\n\n\n",false,0,"2023-03-19T17:51:38+09:00",null,"caa5eeeba93e152cc99a",1,[13,16,19],{"name":14,"versions":15},"MySQL",[],{"name":17,"versions":18},"mysql5.7",[],{"name":20,"versions":21},"Trigger",[],"mysqlのトリガーを使用して他テーブルにデータを作成/更新/削除する","2023-03-19T17:53:53+09:00","https://qiita.com/y5347M/items/caa5eeeba93e152cc99a",{"description":26,"facebook_id":27,"followees_count":28,"followers_count":11,"github_login_name":29,"id":29,"items_count":30,"linkedin_id":27,"location":27,"name":29,"organization":27,"permanent_id":31,"profile_image_url":32,"team_only":6,"twitter_screen_name":33,"website_url":34},"バックエンドエンジニアをしています。","",5,"y5347M",18,2433961,"https://s3-ap-northeast-1.amazonaws.com/qiita-image-store/0/2433961/a4773675e7566e225738c8c15f9fda53e35bd799/large.png?1741427719","mmmm16089306","https://twitter.com/mmmm16089306",8853,{"description":26,"facebook_id":27,"followees_count":28,"followers_count":11,"github_login_name":29,"id":29,"items_count":30,"linkedin_id":27,"location":27,"name":29,"organization":27,"permanent_id":31,"profile_image_url":32,"team_only":6,"twitter_screen_name":33,"website_url":34,"image_monthly_upload_limit":37,"image_monthly_upload_remaining":38},104857600,101432560,1745893161716]